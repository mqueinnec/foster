---
title: "Imputing forest attributes with FOSTER"
author: "Martin Queinnec"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Imputing forest attributes with FOSTER}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width=12, 
  fig.height=8,
  out.width="100%")
library(foster)
library(ggplot2)
library(raster)
library(knitr)
set.seed(1234)
  
```

## Introduction 

The goal of this vignette is to illustrate how FOSTER can be used to impute ALS-derived forest variables (response variables **Y**) to a larger area covered by multispectral satellite imagery and topographic data (predictor variables **X**). We can usually describe an imputation problem by defining two sets of observations: the reference and the target observations. At reference observations, both Y and X variables are defined while only X variables are available at targets. Ultimately, targets are the area where we want to impute response variables. 


FOSTER has been designed around the following workflow: 

* Data preprocessing to match the extent and spatial resolution of input data, mask cells that won't be included in the analysis or perform spatial filtering to smooth the data before main processing
* Calculate spectral indices from multispectral data and summarize time series of spectral indices
* Perform a stratified random sampling to select cells that will be used to train and assess the accuracy of the k-NN model
* Divide the stratified random sample into training and validation sets
* Train a k-NN model from the training set and assess its accuracy with the validation set
* Impute response variables from sampled reference observations to the targets

```{r, echo=FALSE, out.width="80%", fig.cap="FOSTER workflow"}
knitr::include_graphics("https://raw.githubusercontent.com/mqueinnec/storage/main/FOSTER/FOSTER_workflow.png")
```

## Using FOSTER

### Load packages
In order to use the functions of FOSTER directly we need to attach the package using `library()`. Otherwise the functions need to be called explicitly from foster namespace using `foster::function_name()`. The `raster` package is regularly used throughout the workflow to read data using the functions `raster`, `stack` or `brick` (see below). It is therefore recommended attach the `raster` package as well. 

```{r}
library(foster)
library(raster)
```

### Main functions implemented in FOSTER

#### Data preparation
* `matchExtent`: match the extent of a raster from a reference. Cells of the reference having a specific value can be masked in the output raster object. 
* `matchResolution`: successively project and resample a raster coordinate system and spatial resolution to the ones of a reference raster. The input layer keeps its original extent instead of inheriting from the reference. 
* `focalMultiband`: apply a spatial filter (function) in the neighborhood of each cell. 
* `edges`: assign NA values to cell located in the neighborhood of other cells having NA values. This can be used for example to avoid sampling cells located close to borders. 
* `tile`: split a raster into smaller tiles. Can be used to reduce the size of data to be processed at a time and avoid memory issues. 

#### Stratified random sampling: 

* `getSample`: perform a k-means clustering of a raster and randomly sample cells within each cluster proportionally to the presence of those clusters across the entire raster
* `getSampleValues`: extract the values of a raster at sample points 

#### Calculate spectral indices and time series-based metrics

These functions supports both raster and point features (ESRI Shapefiles) to calculate wall-to-wall predictor variables or only at sampled observations

* `calcIndices`: calculate a set of spectral indices from multispectral data
* `temporalMetrics`: summarize variables time series in a few metrics (e.g. mean, median, slope, IQR) 

#### Train a k-NN model and assess its accuracy 

* `partition`: split samples into training and testing sets
* `trainNN`: train a k-NN model from the training sets and use the trained model to impute the Y variables on the testing set. Also returns the model accuracy by comparing observed and imputed response variables from the testing set
* `accuracy`: compute accuracy metrics from observed and predicted variables
* `scatter` : create a scatterplot between observed and predicted variables
* `varImp`: return the importance of each predictor variable if random forest is used to calculate the nearest neighbors

#### Impute response variables at targets

* `predictTrgs`: impute response variables from a trained k-NN model and predictor variables at targets.

### Data types

Two types of data are encountered when using FOSTER: raster data for wall-to-wall variables and vectors for variables extracted at sample points (point features). 

### Reading data from disk

#### Raster data

If the raster contains a single layer it can be read with `raster()` to create a `RasterLayer` object . However, if it is a raster with multiple layers, `stack()` (`RasterStack`) or `brick()` (`RasterBrick`) should be used. `RasterBrick` are usually more efficient to process but they can only point to a single file while `RasterStack` can be assembled of layers from different file sources. `RasterStack` objects can also be created from multiple `RasterLayer` objects. 
The functions `raster`, `stack` and `brick` take the filename (full path to file or relative path from your current working directory) of the raster as an argument. Please refer to the documentation of these functions to learn more about the various options and file types supported by the raster package. 

```{r raster-noeval, eval = F}
#Read single layer raster
raster_layer <- raster("path/to/raster_layer.tif")
#Read multi-layer raster
raster_stack <- stack("path/to/raster_stack.tif")
```
 
### Topographic data 

Elevation (DEM) and terrain slope (DEM_slope) data are derived from the Advanced Spaceborne Thermal Emission and Reflection Radiometer (ASTER) global Digital Elevation Model (GDEM, v.2).Both DEM and DEM_slope were resampled to a 30 m spatial resolution and aligned with the multispectral data grid.

```{r open-dem}
tryCatch({
  dem <- system.file("extdata/inputs/topo/DEM.tif",package="foster")
  dem <- raster(dem)
  plot(dem)
}, 
error = function(cond) {
  message("System.file fail")
})
```

```{r open-slope}
tryCatch({
  dem_slope <- system.file("extdata/inputs/topo/DEM_slope.tif",package="foster")
  dem_slope <- raster(dem_slope)
  plot(dem_slope)
}, 
error = function(cond) {
  message("System.file fail")
})
```

```{r open-BAP}
tryCatch({
  bap_2006 <- system.file("extdata/inputs/Landsat_BAP/Landsat_BAP_2006.tif",package="foster")
  bap_2006 <- stack(bap_2006)
  plot(bap_2006)
}, 
error = function(cond) {
  message("System.file fail")
})
```


